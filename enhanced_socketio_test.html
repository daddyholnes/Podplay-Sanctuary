<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Socket.IO Test Client</title>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .connected { background-color: #d4edda; color: #155724; }
    .disconnected { background-color: #f8d7da; color: #721c24; }
    .connecting { background-color: #d1ecf1; color: #0c5460; }
    .logs {
      height: 250px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      font-family: monospace;
      margin-bottom: 20px;
    }
    button {
      padding: 8px 12px;
      margin-right: 5px;
    }
    .server-panel {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }
    h2 {
      margin-top: 0;
    }
    .control-row {
      margin-bottom: 10px;
    }
    .test-options {
      margin-top: 10px;
    }
    .settings-panel {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Enhanced Socket.IO Test Client</h1>
  
  <div class="settings-panel">
    <h3>Connection Settings</h3>
    <div>
      <label>
        <input type="checkbox" id="debugMode" checked>
        Debug Mode (verbose logging)
      </label>
    </div>
    <div>
      <label>
        Transport Mode:
        <select id="transportMode">
          <option value="['polling', 'websocket']">Auto (polling â†’ websocket)</option>
          <option value="['websocket']">WebSocket Only</option>
          <option value="['polling']">Polling Only</option>
        </select>
      </label>
    </div>
  </div>
  
  <!-- Node.js Test Server -->
  <div class="server-panel">
    <h2>Node.js Socket.IO Test Server</h2>
    <div class="control-row">
      <label for="nodeServerUrl">Server URL:</label>
      <input type="text" id="nodeServerUrl" value="http://localhost:3000" style="width: 300px;">
      <button id="nodeConnectBtn">Connect</button>
      <button id="nodeDisconnectBtn">Disconnect</button>
    </div>
    <div id="nodeStatus" class="status connecting">Not connected</div>
    <div class="test-options">
      <button id="nodeSendTestBtn">Send Test Event</button>
      <button id="nodeGetSocketInfoBtn">Get Socket Info</button>
    </div>
    <h4>Event Log:</h4>
    <div id="nodeLog" class="logs"></div>
  </div>
  
  <!-- Flask Backend Server -->
  <div class="server-panel">
    <h2>Flask Backend Server</h2>
    <div class="control-row">
      <label for="flaskServerUrl">Server URL:</label>
      <input type="text" id="flaskServerUrl" value="http://localhost:5000" style="width: 300px;">
      <button id="flaskConnectBtn">Connect</button>
      <button id="flaskDisconnectBtn">Disconnect</button>
    </div>
    <div id="flaskStatus" class="status connecting">Not connected</div>
    <div class="test-options">
      <button id="flaskSendTestBtn">Send Test Event</button>
      <button id="flaskGetSocketInfoBtn">Get Socket Info</button>
    </div>
    <h4>Event Log:</h4>
    <div id="flaskLog" class="logs"></div>
  </div>

  <script>
    const debugModeCheckbox = document.getElementById('debugMode');
    const transportModeSelect = document.getElementById('transportMode');
    
    // Node.js server elements
    const nodeServerUrlInput = document.getElementById('nodeServerUrl');
    const nodeConnectBtn = document.getElementById('nodeConnectBtn');
    const nodeDisconnectBtn = document.getElementById('nodeDisconnectBtn');
    const nodeSendTestBtn = document.getElementById('nodeSendTestBtn');
    const nodeGetSocketInfoBtn = document.getElementById('nodeGetSocketInfoBtn');
    const nodeStatusEl = document.getElementById('nodeStatus');
    const nodeLogEl = document.getElementById('nodeLog');
    
    // Flask server elements
    const flaskServerUrlInput = document.getElementById('flaskServerUrl');
    const flaskConnectBtn = document.getElementById('flaskConnectBtn');
    const flaskDisconnectBtn = document.getElementById('flaskDisconnectBtn');
    const flaskSendTestBtn = document.getElementById('flaskSendTestBtn');
    const flaskGetSocketInfoBtn = document.getElementById('flaskGetSocketInfoBtn');
    const flaskStatusEl = document.getElementById('flaskStatus');
    const flaskLogEl = document.getElementById('flaskLog');
    
    // Socket instances
    let nodeSocket = null;
    let flaskSocket = null;
    
    // Log helper function
    function log(element, message, type = 'info') {
      const entry = document.createElement('div');
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      
      if (type === 'error') entry.style.color = '#dc3545';
      if (type === 'success') entry.style.color = '#28a745';
      if (type === 'debug') entry.style.color = '#6c757d';
      
      element.appendChild(entry);
      element.scrollTop = element.scrollHeight;
      
      if (type !== 'debug' || debugModeCheckbox.checked) {
        console.log(`[${element.id}] ${message}`);
      }
    }
    
    // Update status display
    function updateStatus(element, text, className) {
      element.textContent = text;
      element.className = 'status ' + className;
    }
    
    // Get transport mode from select
    function getTransportMode() {
      return JSON.parse(transportModeSelect.value);
    }
    
    // Get connection options
    function getConnectionOptions() {
      return {
        transports: getTransportMode(),
        reconnectionAttempts: 5,
        reconnectionDelay: 1000,
        timeout: 20000
      };
    }
    
    // Get detailed socket info
    function getSocketInfo(socket) {
      if (!socket || !socket.connected) {
        return 'Not connected';
      }
      
      return {
        id: socket.id,
        connected: socket.connected,
        disconnected: socket.disconnected,
        transport: socket.io.engine.transport.name,
        upgradeTransport: socket.io.engine.transport.upgrading,
        protocol: socket.io.protocol,
        url: socket.io.uri,
        hostname: socket.io.engine.hostname,
        path: socket.io.engine.path,
        timestampRequests: socket.io.engine.timestampRequests,
        timestampParam: socket.io.engine.timestampParam,
        secure: socket.io.engine.secure
      };
    }
    
    // Connect to Node.js server
    nodeConnectBtn.addEventListener('click', () => {
      if (nodeSocket) {
        log(nodeLogEl, 'Already connected! Disconnect first.');
        return;
      }
      
      try {
        const serverUrl = nodeServerUrlInput.value;
        log(nodeLogEl, `Connecting to ${serverUrl}...`);
        log(nodeLogEl, `Using transport mode: ${transportModeSelect.value}`, 'debug');
        updateStatus(nodeStatusEl, 'Connecting...', 'connecting');
        
        // Initialize Socket.IO connection
        nodeSocket = io(serverUrl, getConnectionOptions());
        
        // Connection events
        nodeSocket.on('connect', () => {
          log(nodeLogEl, `Connected successfully! Socket ID: ${nodeSocket.id}`, 'success');
          updateStatus(nodeStatusEl, `Connected (ID: ${nodeSocket.id})`, 'connected');
          
          // Log connection details
          const details = {
            id: nodeSocket.id,
            transport: nodeSocket.io.engine.transport.name
          };
          log(nodeLogEl, `Connection details: ${JSON.stringify(details)}`);
        });
        
        nodeSocket.on('connect_error', (err) => {
          log(nodeLogEl, `Connection error: ${err.message}`, 'error');
          updateStatus(nodeStatusEl, `Error: ${err.message}`, 'disconnected');
        });
        
        nodeSocket.on('disconnect', (reason) => {
          log(nodeLogEl, `Disconnected: ${reason}`);
          updateStatus(nodeStatusEl, `Disconnected: ${reason}`, 'disconnected');
          nodeSocket = null;
        });
        
        // Custom events
        nodeSocket.on('message', (data) => {
          log(nodeLogEl, `Received message: ${data}`);
        });
        
        nodeSocket.on('test_response', (data) => {
          log(nodeLogEl, `Test response: ${data}`, 'success');
        });
        
        nodeSocket.on('error', (error) => {
          log(nodeLogEl, `Error: ${error}`, 'error');
        });

        // Add any data received
        nodeSocket.onAny((event, ...args) => {
          log(nodeLogEl, `Event: ${event}, Data: ${JSON.stringify(args)}`, 'debug');
        });
        
      } catch (err) {
        log(nodeLogEl, `Error: ${err.message}`, 'error');
        updateStatus(nodeStatusEl, `Error: ${err.message}`, 'disconnected');
      }
    });
    
    // Connect to Flask server
    flaskConnectBtn.addEventListener('click', () => {
      if (flaskSocket) {
        log(flaskLogEl, 'Already connected! Disconnect first.');
        return;
      }
      
      try {
        const serverUrl = flaskServerUrlInput.value;
        log(flaskLogEl, `Connecting to ${serverUrl}...`);
        log(flaskLogEl, `Using transport mode: ${transportModeSelect.value}`, 'debug');
        updateStatus(flaskStatusEl, 'Connecting...', 'connecting');
        
        // Initialize Socket.IO connection
        flaskSocket = io(serverUrl, getConnectionOptions());
        
        // Connection events
        flaskSocket.on('connect', () => {
          log(flaskLogEl, `Connected successfully! Socket ID: ${flaskSocket.id}`, 'success');
          updateStatus(flaskStatusEl, `Connected (ID: ${flaskSocket.id})`, 'connected');
          
          // Log connection details
          const details = {
            id: flaskSocket.id,
            transport: flaskSocket.io.engine.transport.name
          };
          log(flaskLogEl, `Connection details: ${JSON.stringify(details)}`);
        });
        
        flaskSocket.on('connect_error', (err) => {
          log(flaskLogEl, `Connection error: ${err.message}`, 'error');
          updateStatus(flaskStatusEl, `Error: ${err.message}`, 'disconnected');
        });
        
        flaskSocket.on('disconnect', (reason) => {
          log(flaskLogEl, `Disconnected: ${reason}`);
          updateStatus(flaskStatusEl, `Disconnected: ${reason}`, 'disconnected');
          flaskSocket = null;
        });
        
        // Custom events
        flaskSocket.on('connected', (data) => {
          log(flaskLogEl, `Received connected event: ${JSON.stringify(data)}`);
        });
        
        flaskSocket.on('message', (data) => {
          log(flaskLogEl, `Received message: ${JSON.stringify(data)}`);
        });
        
        flaskSocket.on('error', (error) => {
          log(flaskLogEl, `Error: ${error}`, 'error');
        });

        // Add any data received
        flaskSocket.onAny((event, ...args) => {
          log(flaskLogEl, `Event: ${event}, Data: ${JSON.stringify(args)}`, 'debug');
        });
        
      } catch (err) {
        log(flaskLogEl, `Error: ${err.message}`, 'error');
        updateStatus(flaskStatusEl, `Error: ${err.message}`, 'disconnected');
      }
    });
    
    // Disconnect from Node.js server
    nodeDisconnectBtn.addEventListener('click', () => {
      if (nodeSocket) {
        nodeSocket.disconnect();
        log(nodeLogEl, 'Manually disconnected');
        updateStatus(nodeStatusEl, 'Disconnected (manual)', 'disconnected');
        nodeSocket = null;
      } else {
        log(nodeLogEl, 'Not connected!');
      }
    });
    
    // Disconnect from Flask server
    flaskDisconnectBtn.addEventListener('click', () => {
      if (flaskSocket) {
        flaskSocket.disconnect();
        log(flaskLogEl, 'Manually disconnected');
        updateStatus(flaskStatusEl, 'Disconnected (manual)', 'disconnected');
        flaskSocket = null;
      } else {
        log(flaskLogEl, 'Not connected!');
      }
    });
    
    // Send test event to Node.js server
    nodeSendTestBtn.addEventListener('click', () => {
      if (nodeSocket && nodeSocket.connected) {
        const testData = {
          message: 'Hello from test client',
          timestamp: new Date().toISOString()
        };
        nodeSocket.emit('test', testData);
        log(nodeLogEl, `Sent test event: ${JSON.stringify(testData)}`);
      } else {
        log(nodeLogEl, 'Not connected! Cannot send test.', 'error');
      }
    });
    
    // Send test event to Flask server
    flaskSendTestBtn.addEventListener('click', () => {
      if (flaskSocket && flaskSocket.connected) {
        const testData = {
          message: 'Hello from test client',
          timestamp: new Date().toISOString()
        };
        flaskSocket.emit('test', testData);
        log(flaskLogEl, `Sent test event: ${JSON.stringify(testData)}`);
      } else {
        log(flaskLogEl, 'Not connected! Cannot send test.', 'error');
      }
    });
    
    // Get Node.js socket info
    nodeGetSocketInfoBtn.addEventListener('click', () => {
      const socketInfo = getSocketInfo(nodeSocket);
      log(nodeLogEl, `Socket info: ${JSON.stringify(socketInfo, null, 2)}`, 'debug');
    });
    
    // Get Flask socket info
    flaskGetSocketInfoBtn.addEventListener('click', () => {
      const socketInfo = getSocketInfo(flaskSocket);
      log(flaskLogEl, `Socket info: ${JSON.stringify(socketInfo, null, 2)}`, 'debug');
    });
    
    // Log browser details
    const browserInfo = {
      url: window.location.href,
      userAgent: navigator.userAgent,
      origin: window.location.origin
    };
    log(nodeLogEl, `Browser info: ${JSON.stringify(browserInfo)}`, 'debug');
    log(flaskLogEl, `Browser info: ${JSON.stringify(browserInfo)}`, 'debug');
  </script>
</body>
</html>
