<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podplay Sanctuary - Socket.IO Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        #status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow: auto;
            max-height: 300px;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0069d9;
        }
        #events {
            margin-top: 20px;
        }
        .event-item {
            padding: 8px;
            margin: 5px 0;
            border-left: 4px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>Podplay Sanctuary - Socket.IO Connection Test</h1>
    
    <div id="status" class="info">Testing connection...</div>
    
    <div>
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn">Disconnect</button>
        <button id="testEventBtn">Send Test Event</button>
        <button id="clearBtn">Clear Events</button>
    </div>
    
    <div id="events"></div>
    
    <h2>Connection Details</h2>
    <pre id="details">Waiting for connection...</pre>
      <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        // Helper function to parse URL params
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        const statusEl = document.getElementById('status');
        const detailsEl = document.getElementById('details');
        const eventsEl = document.getElementById('events');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const testEventBtn = document.getElementById('testEventBtn');
        const clearBtn = document.getElementById('clearBtn');        
        // Check for URL params
        const urlPort = getUrlParameter('port') || '5000';
        const urlTransport = getUrlParameter('transport') || 'polling,websocket';
        
        // Get the browser's current origin, which we'll use if the "useOrigin" param is set
        const useCurrentOrigin = getUrlParameter('useOrigin') === 'true';
        
        let socket = null;
        
        function updateStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = type;
        }
        
        function logEvent(message) {
            const eventEl = document.createElement('div');
            eventEl.className = 'event-item';
            eventEl.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            eventsEl.prepend(eventEl);
        }
        
        function updateDetails() {
            if (!socket) {
                detailsEl.textContent = 'No active connection';
                return;
            }
            
            const details = {
                id: socket.id || 'Not assigned yet',
                connected: socket.connected,
                disconnected: socket.disconnected,
                transport: socket.io?.engine?.transport?.name || 'N/A',
                protocol: socket.io?.engine?.protocol || 'N/A',
                uri: socket.io?.uri || 'N/A'
            };
            
            detailsEl.textContent = JSON.stringify(details, null, 2);
        }
        
        connectBtn.addEventListener('click', () => {
            try {                updateStatus('Connecting...', 'info');
                
                // Use current origin if useOrigin is true, otherwise use localhost
                const url = useCurrentOrigin ? window.location.origin : `http://localhost:${urlPort}`;
                const transports = urlTransport.split(',');
                
                logEvent(`Connecting to ${url} with transports: ${transports.join(', ')}`);
                socket = io(url, {
                    transports: transports,
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000,
                    timeout: 20000,
                    // Using default Socket.IO path
                    upgrade: true,        // Allow transport upgrade
                    forceNew: true,       // Force a new connection
                    autoConnect: true,    // Connect immediately
                    reconnection: true    // Enable reconnection
                });
                
                socket.on('connect', () => {
                    updateStatus('Connected!', 'success');
                    logEvent('Connected to server');
                    updateDetails();
                });
                
                socket.on('disconnect', (reason) => {
                    updateStatus('Disconnected: ' + reason, 'error');
                    logEvent(`Disconnected: ${reason}`);
                    updateDetails();
                });
                
                socket.on('connect_error', (error) => {
                    updateStatus('Connection Error: ' + error.message, 'error');
                    logEvent(`Connection Error: ${error.message}`);
                    updateDetails();
                });
                
                socket.on('reconnect_attempt', (attemptNumber) => {
                    updateStatus(`Reconnect attempt #${attemptNumber}`, 'info');
                    logEvent(`Reconnect attempt #${attemptNumber}`);
                });
                
                // Custom test event handler
                socket.on('test_response', (data) => {
                    logEvent(`Received test_response: ${JSON.stringify(data)}`);
                });
                
            } catch (err) {
                updateStatus('Error: ' + err.message, 'error');
                console.error(err);
            }
        });
        
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
                logEvent('Manually disconnected');
            }
        });
        
        testEventBtn.addEventListener('click', () => {
            if (socket && socket.connected) {
                socket.emit('test_event', { message: 'Hello from test client!' });
                logEvent('Sent test_event');
            } else {
                logEvent('Cannot send event: Not connected');
            }
        });
        
        clearBtn.addEventListener('click', () => {
            eventsEl.innerHTML = '';
        });
        
        // Auto-connect on page load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => connectBtn.click(), 1000);
        });
        
        // Update details periodically
        setInterval(updateDetails, 2000);
    </script>
</body>
</html>
