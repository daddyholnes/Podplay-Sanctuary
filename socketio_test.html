<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.IO Express Test</title>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .connected { background-color: #d4edda; color: #155724; }
    .disconnected { background-color: #f8d7da; color: #721c24; }
    .connecting { background-color: #d1ecf1; color: #0c5460; }
    #log {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      font-family: monospace;
    }
    button {
      padding: 8px 12px;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h1>Socket.IO Express Test</h1>
  
  <div>
    <label for="serverUrl">Server URL:</label>
    <input type="text" id="serverUrl" value="http://localhost:3000">
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn">Disconnect</button>
    <button id="sendTestBtn">Send Test</button>
  </div>
  
  <div id="status" class="connecting">Not connected</div>
  
  <h3>Event Log:</h3>
  <div id="log"></div>

  <script>
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const serverUrlInput = document.getElementById('serverUrl');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendTestBtn = document.getElementById('sendTestBtn');
    
    let socket = null;
    
    // Log helper function
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      if (type === 'error') entry.style.color = '#dc3545';
      if (type === 'success') entry.style.color = '#28a745';
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }
    
    // Update status display
    function updateStatus(text, className) {
      statusEl.textContent = text;
      statusEl.className = className;
    }
    
    // Connect to server
    connectBtn.addEventListener('click', () => {
      if (socket) {
        log('Already connected! Disconnect first.');
        return;
      }
      
      try {
        const serverUrl = serverUrlInput.value;
        log(`Connecting to ${serverUrl}...`);
        updateStatus('Connecting...', 'connecting');
        
        // Initialize Socket.IO connection
        socket = io(serverUrl, {
          transports: ['polling', 'websocket'],
          reconnectionAttempts: 3
        });
        
        // Connection events
        socket.on('connect', () => {
          log(`Connected successfully! Socket ID: ${socket.id}`, 'success');
          updateStatus(`Connected (ID: ${socket.id})`, 'connected');
          
          // Log connection details
          const details = {
            id: socket.id,
            transport: socket.io.engine.transport.name,
            upgrade: socket.io.engine.transport.name !== 'polling',
            url: socket.io.uri
          };
          log(`Connection details: ${JSON.stringify(details)}`);
        });
        
        socket.on('connect_error', (err) => {
          log(`Connection error: ${err.message}`, 'error');
          updateStatus(`Error: ${err.message}`, 'disconnected');
        });
        
        socket.on('disconnect', (reason) => {
          log(`Disconnected: ${reason}`);
          updateStatus(`Disconnected: ${reason}`, 'disconnected');
          socket = null;
        });
        
        // Custom events
        socket.on('message', (data) => {
          log(`Received message: ${data}`);
        });
        
        socket.on('test_response', (data) => {
          log(`Test response: ${data}`, 'success');
        });
        
      } catch (err) {
        log(`Error: ${err.message}`, 'error');
        updateStatus(`Error: ${err.message}`, 'disconnected');
      }
    });
    
    // Disconnect from server
    disconnectBtn.addEventListener('click', () => {
      if (socket) {
        socket.disconnect();
        log('Manually disconnected');
        updateStatus('Disconnected (manual)', 'disconnected');
      } else {
        log('Not connected!');
      }
    });
    
    // Send test event
    sendTestBtn.addEventListener('click', () => {
      if (socket && socket.connected) {
        const testData = {
          message: 'Hello from test client',
          timestamp: new Date().toISOString()
        };
        socket.emit('test', testData);
        log(`Sent test event: ${JSON.stringify(testData)}`);
      } else {
        log('Not connected! Cannot send test.', 'error');
      }
    });
    
    // Log browser details
    log(`Page URL: ${window.location.href}`);
    log(`Browser: ${navigator.userAgent}`);
  </script>
</body>
</html>
